#!/usr/bin/env bash

set -e

delimiter="\n"

if [ $# -ge 2 ] && [ "$1" == "-d" ] ; then
    delimiter="$2"
    shift
    shift
fi


src_weather_dir=~
src_weather_base=.weather
src_weather="$src_weather_dir/$src_weather_base"
src_weather_current_threshold=15 # mins

src_weather_current="$(fd -g "$src_weather_base" --changed-within ${src_weather_current_threshold}min -uu -d1 "$src_weather_dir" | wc -l)"

if ! [ -e $src_weather_dir/$src_weather_base ] || [ $src_weather_current -eq 0 ]; then

    rm $src_weather
    src_tmp=$(mktemp)

    curl -sm1 'https://wttr.in/?format=location="%l"\ncondition="%c"\ntemperature="%t"\nfeels="%f"\nsunrise="%S"\nsunset="%s"\nhumidity="%h"\nwind="%w"\nprecipitation="%p"\npressure="%P"\ncondition_desc="%C"\nmoon="%m"\n' > $src_tmp

    if [ -s $src_tmp ] && ! [ -e $src_weather ]; then
        rm $src_weather
        mv $src_tmp $src_weather
    else
        rm $src_tmp
    fi
fi

. "$src_weather"

condition="${condition%[[:space:]]*}"
sunrise="${sunrise%:??}"
sunset="${sunset%:??}"
feels="${feels%C}"
feels="${feels#+}"
[[ "$feels" == "-0Â°" ]] && feels="0Â°"
temperature="${temperature%C}"
temperature="${temperature#+}"
[[ "$temperature" == "-0Â°" ]] && temperature="0Â°"

while [ $# -gt 0 ] ; do

    if [[ "$1" == "%"* ]]; then
        wanted="${1#'%'}"
        output="${!wanted}"

        if [ -n "${output}" ] ; then
            echo "${output}"
        fi
        
    elif [[ "$1" == "--wonkydetail" ]]; then
        echo -e "$location\nðŸŒ¡$temperature ðŸŒž${sunrise} ${moon}${sunset}"
    else
        echo "${1}"
    fi

    shift
done | while read -r w_item; do
    printf "%s%s" "$w_item" "$w_delimiter"
done
